{% extends "menstrual/base_menstrual.html" %}
{% from "macros/datetime.html" import format_date, days_until %}

{% block title %}Analytics - Menstrual Tracker - HerCure{% endblock %}

{% block extra_css %}
<style>
    /* Main chart container */
    .chart-container {
        background: white;
        border-radius: 0.15rem;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.03);
        padding: 0.15rem;
        margin: 0.1rem;
        height: 80px;
        width: calc(50% - 0.2rem);
        display: inline-block;
        vertical-align: top;
        box-sizing: border-box;
    }
    
    /* Make charts stack on mobile */
    @media (max-width: 768px) {
        .chart-container {
            width: 100%;
            margin: 0.1rem 0;
            height: 90px;
        }
    }
    
    .chart-title {
        font-size: 0.6rem;
        font-weight: 600;
        color: #4B5563;
        margin: 0;
        padding: 0.05rem 0.15rem;
        display: flex;
        align-items: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chart-title i {
        margin-right: 0.3rem;
        font-size: 0.7em;
        color: #EC4899;
    }
    
    .chart-wrapper {
        position: relative;
        height: 55px;
        width: 100%;
        margin: 0;
        padding: 0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    @media (min-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin: 0.5rem 0;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6B7280;
    }
    
    .no-data {
        text-align: center;
        padding: 2rem;
        color: #9CA3AF;
    }
    
    .no-data i {
        font-size: 2rem;
        margin-bottom: 1rem;
        color: #E5E7EB;
    }
    
    .stat-card {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
        transition: all 0.2s;
    }
    .stat-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .stat-value {
        font-size: 1.875rem;
        font-weight: 700;
        color: #9d174d;
        margin-top: 0.5rem;
    }
    .stat-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .chart-container {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    .chart-title i {
        margin-right: 0.5rem;
        color: #9d174d;
    }
    .chart-wrapper {
        position: relative;
        height: 55px;
        width: 100%;
        margin: 0;
        padding: 0;
    }
    .symptom-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        background-color: #fce7f3;
        color: #9d174d;
    }
    .phase-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 6px;
    }
    
    /* Enhanced chart styles */
    .chart-container {
        background: white;
        border-radius: 0.25rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        padding: 0.25rem;
        margin: 0.25rem;
        height: 140px;
        width: calc(50% - 0.5rem);
        display: inline-block;
        vertical-align: top;
    }
    @media (max-width: 768px) {
        .chart-container {
            width: 100%;
        }
    }
    .chart-title {
        font-size: 0.6rem;
        font-weight: 600;
        color: #4B5563;
        margin: 0;
        padding: 0.05rem 0.15rem;
        display: flex;
        align-items: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chart-title i {
        margin-right: 0.3rem;
        font-size: 0.7em;
        color: #EC4899;
    }
    .chart-wrapper {
        position: relative;
        height: 55px;
        width: 100%;
        margin: 0;
        padding: 0;
    }
</style>
{% endblock %}

{% block menstrual_content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Menstrual Analytics</h1>
            <p class="mt-1 text-sm text-gray-500">AI-powered insights into your menstrual health</p>
            
            {% if current_phase %}
            <div class="mt-2 flex items-center text-sm text-gray-600">
                <span class="phase-indicator 
                    {% if current_phase == 'Menstrual' %}bg-red-500
                    {% elif current_phase == 'Follicular' %}bg-blue-500
                    {% elif current_phase == 'Ovulation' %}bg-green-500
                    {% else %}bg-purple-500{% endif %}"></span>
                <span>Currently in <span class="font-medium">{{ current_phase }}</span> phase 
                {% if day_of_cycle %}(Day {{ day_of_cycle }}){% endif %}</span>
            </div>
            {% endif %}
        </div>
        <div class="mt-4 md:mt-0">
            <a href="{{ url_for('menstrual.tracker') }}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-brand-pink-600 hover:bg-brand-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-pink-500">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Tracker
            </a>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Average Cycle</div>
            <div class="stat-value">{{ stats.avg_cycle_length|default('--', true) }}<span class="text-sm text-gray-500"> days</span></div>
            <div class="text-xs text-gray-500">Based on {{ stats.total_cycles|default(0) }} cycles</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Average Period</div>
            <div class="stat-value">{{ stats.avg_period_length|default('--', true) }}<span class="text-sm text-gray-500"> days</span></div>
            <div class="text-xs text-gray-500">Based on {{ stats.total_periods|default(0) }} periods</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Current Phase</div>
            <div class="stat-value">{{ current_phase|default('--', true) }}</div>
            <div class="text-xs text-gray-500">Day {{ day_of_cycle|default('--', true) }} of cycle</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Next Period</div>
            {% if next_period %}
                <div class="stat-value">{{ next_period.strftime('%b %d') }}</div>
                <div class="text-xs text-gray-500">{{ (next_period - now).days }} days from now</div>
            {% else %}
                <div class="stat-value">--</div>
                <div class="text-xs text-gray-500">Not enough data</div>
            {% endif %}
        </div>
    </div>

    <!-- Charts Section -->
    <div class="w-full flex flex-wrap justify-between">
        <!-- Cycle Length Chart -->
        <div class="chart-container">
            <h2 class="chart-title">
                <i class="fas fa-calendar-alt"></i>
                Cycle Length History
            </h2>
            <div class="chart-wrapper">
                <canvas id="cycleLengthChart"></canvas>
                <div id="noCycleData" class="no-data hidden">
                    <i class="fas fa-chart-line"></i>
                    <p>No cycle data available</p>
                    <p class="text-sm">Log your periods to see cycle history</p>
                    <a href="{{ url_for('menstrual.log_cycle') }}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-brand-pink-600 hover:bg-brand-pink-700 mt-2">
                        <i class="fas fa-plus mr-1"></i> Log Period
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Period Length Chart -->
        <div class="chart-container" style="min-width: 300px; flex: 1 0 calc(50% - 0.5rem);">
            <h2 class="chart-title">
                <i class="fas fa-tint"></i>
                Period Length History
            </h2>
            <div class="chart-wrapper">
                <canvas id="periodLengthChart"></canvas>
                <div id="noPeriodData" class="no-data hidden">
                    <i class="fas fa-chart-bar"></i>
                    <p>No period data available</p>
                    <p class="text-sm">Log your periods to track length</p>
                    <a href="{{ url_for('menstrual.log_cycle') }}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-brand-pink-600 hover:bg-brand-pink-700 mt-2">
                        <i class="fas fa-plus mr-1"></i> Log Period
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Symptoms Chart -->
        <div class="chart-container" style="min-width: 300px; flex: 1 0 calc(50% - 0.5rem);">
            <h2 class="chart-title">
                <i class="fas fa-sticky-note"></i>
                Common Symptoms
            </h2>
            <div class="chart-wrapper">
                <canvas id="symptomsChart"></canvas>
                <div id="noSymptomsData" class="no-data hidden">
                    <i class="fas fa-notes-medical"></i>
                    <p>No symptom data available</p>
                    <p class="text-sm">Log your symptoms to see patterns</p>
                    <a href="{{ url_for('menstrual.log_symptom') }}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-brand-pink-600 hover:bg-brand-pink-700 mt-2">
                        <i class="fas fa-plus mr-1"></i> Log Symptoms
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Mood Chart -->
        <div class="chart-container" style="min-width: 300px; flex: 1 0 calc(50% - 0.5rem);">
            <h2 class="chart-title">
                <i class="fas fa-smile"></i>
                Mood Patterns
            </h2>
            <div class="chart-wrapper">
                <canvas id="moodChart"></canvas>
                <div id="noMoodData" class="no-data hidden">
                    <i class="fas fa-smile-beam"></i>
                    <p>No mood data available</p>
                    <p class="text-sm">Log your mood to see patterns</p>
                    <a href="{{ url_for('menstrual.log_symptom') }}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-brand-pink-600 hover:bg-brand-pink-700 mt-2">
                        <i class="fas fa-plus mr-1"></i> Log Mood
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Flow Intensity Chart -->
        <div class="chart-container" style="min-width: 300px; flex: 1 0 calc(50% - 0.5rem);">
            <h2 class="chart-title">
                <i class="fas fa-tint"></i>
                Flow Intensity
            </h2>
            <div class="chart-wrapper">
                <canvas id="flowIntensityChart"></canvas>
                <div id="noFlowData" class="no-data hidden">
                    <i class="fas fa-chart-pie"></i>
                    <p>No flow data available</p>
                    <p class="text-sm">Log your period flow to see patterns</p>
                    <a href="{{ url_for('menstrual.log_cycle') }}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-brand-pink-600 hover:bg-brand-pink-700 mt-2">
                        <i class="fas fa-plus mr-1"></i> Log Period
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Pain Level Chart -->
        <div class="chart-container" style="min-width: 300px; flex: 1 0 calc(50% - 0.5rem);">
            <h2 class="chart-title">
                <i class="fas fa-pain-location"></i>
                Pain Levels
            </h2>
            <div class="chart-wrapper">
                <canvas id="painLevelChart"></canvas>
                <div id="noPainData" class="no-data hidden">
                    <i class="fas fa-chart-bar"></i>
                    <p>No pain data available</p>
                    <p class="text-sm">Log your pain levels to see patterns</p>
                    <a href="{{ url_for('menstrual.log_symptom') }}" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-brand-pink-600 hover:bg-brand-pink-700 mt-2">
                        <i class="fas fa-plus mr-1"></i> Log Symptoms
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Predictions -->
    {% if next_periods|length > 0 %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Period Predictions</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for period in next_periods %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <p class="text-sm font-medium text-gray-500">
                        {% if loop.first %}Next Period
                        {% elif loop.index == 2 %}Following Period
                        {% else %}Future Period
                        {% endif %}
                    </p>
                    <p class="text-lg font-semibold mt-1">
                        {{ period.start_date.strftime('%b %-d') }} - {{ period.end_date.strftime('%-d') }}
                    </p>
                    <div class="mt-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-brand-pink-100 text-brand-pink-800">
                            {{ period.confidence|int }}% confidence
                        </span>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <!-- Additional charts will be added here as needed -->

</div>
{% endblock %}

{% block content %}
<div class="container mx-auto px-2 py-2">
    <!-- Page Header -->
    <div class="mb-2">
        <h1 class="text-lg font-bold text-gray-900">Menstrual Analytics</h1>
            <p class="text-gray-600">Track and analyze your menstrual cycle patterns</p>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-medium text-gray-500">Average Cycle</h3>
            <p class="text-2xl font-semibold text-gray-900">{{ stats.avg_cycle_length|default('--', true) }} days</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-medium text-gray-500">Average Period</h3>
            <p class="text-2xl font-semibold text-gray-900">{{ stats.avg_period_length|default('--', true) }} days</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-medium text-gray-500">Current Phase</h3>
            <p class="text-2xl font-semibold text-gray-900">{{ current_phase|default('--', true) }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-medium text-gray-500">Day {{ day_of_cycle if day_of_cycle else '--' }}</h3>
            <p class="text-2xl font-semibold text-gray-900">of Cycle</p>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="space-y-8">
        {% if 'cycle_length' in charts %}
        <!-- Cycle Length Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Cycle Length Over Time</h2>
            <img src="data:image/png;base64,{{ charts.cycle_length }}" alt="Cycle Length Chart" class="w-full">
        </div>
        {% endif %}

        {% if 'period_length' in charts %}
        <!-- Period Length Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Period Length Over Time</h2>
            <img src="data:image/png;base64,{{ charts.period_length }}" alt="Period Length Chart" class="w-full">
        </div>
        {% endif %}

        {% if 'symptoms' in charts %}
        <!-- Symptoms Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Most Common Symptoms</h2>
            <img src="data:image/png;base64,{{ charts.symptoms }}" alt="Symptoms Chart" class="w-full">
        </div>
        {% endif %}

        {% if 'moods' in charts %}
        <!-- Mood Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Mood Distribution</h2>
            <img src="data:image/png;base64,{{ charts.moods }}" alt="Mood Chart" class="w-full">
        </div>
        {% endif %}

        {% if 'flow_intensity' in charts %}
        <!-- Flow Intensity Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Flow Intensity Distribution</h2>
            <img src="data:image/png;base64,{{ charts.flow_intensity }}" alt="Flow Intensity Chart" class="w-full">
        </div>
        {% endif %}

        {% if 'pain_levels' in charts %}
        <!-- Pain Level Chart -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-medium text-gray-900 mb-4">Pain Level Distribution</h2>
            <img src="data:image/png;base64,{{ charts.pain_levels }}" alt="Pain Level Chart" class="w-full">
        </div>
        {% endif %}
    </div>

    <!-- Period Predictions -->
    {% if next_periods %}
    <div class="mt-8 bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Upcoming Period Predictions</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for period in next_periods %}
            <div class="border border-gray-200 rounded-lg p-4 text-center">
                <div class="text-sm text-gray-500">
                    {% if loop.first %}
                    Next Period
                    {% else %}
                    Following
                    {% endif %}
                </div>
                <div class="text-xl font-semibold text-brand-pink-600">
                    {{ period.strftime('%b %d, %Y') }}
                </div>
                <div class="text-sm text-gray-500 mt-1">
                    {{ (period - now).days }} days from now
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Fertility Window -->
    {% if fertile_start and ovulation_day %}
    <div class="mt-8 bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Fertility Window</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="text-sm text-gray-500">Fertile Window</div>
                <div class="text-lg font-semibold text-brand-pink-600">
                    {{ fertile_start.strftime('%b %d') }} - {{ fertile_end.strftime('%b %d, %Y') }}
                </div>
            </div>
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="text-sm text-gray-500">Ovulation Day</div>
                <div class="text-lg font-semibold text-brand-pink-600">
                    {{ ovulation_day.strftime('%b %d, %Y') }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}

<!-- Chart.js with plugins -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1"></script>

<script>
    // Chart configuration with enhanced interactivity
    const chartConfig = {
        line: {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#4B5563',
                            font: {
                                size: 12,
                                family: 'Inter, system-ui, sans-serif'
                            },
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#111827',
                        bodyColor: '#4B5563',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        padding: 4,
                        displayColors: true,
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y} days`;
                            }
                        }
                    },
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'x',
                            speed: 100
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                            speed: 0.5
                        },
                        limits: {
                            x: { min: 'original', max: 'original' },
                            y: { min: 'original', max: 'original' }
                        }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { 
                            color: 'rgba(0, 0, 0, 0.03)',
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#6B7280',
                            font: {
                                size: 11,
                                family: 'Inter, system-ui, sans-serif'
                            }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { 
                            color: '#6B7280',
                            font: {
                                size: 11,
                                family: 'Inter, system-ui, sans-serif'
                            }
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.3,
                        borderWidth: 2,
                        fill: true,
                    },
                    point: {
                        radius: 4,
                        hoverRadius: 6,
                        hoverBorderWidth: 2,
                        backgroundColor: 'white'
                    }
                }
            }
        },
        bar: {
            type: 'bar',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#111827',
                        bodyColor: '#4B5563',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        padding: 4,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y} occurrences`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: '#4B5563',
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        formatter: Math.round
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { 
                            color: 'rgba(0, 0, 0, 0.03)',
                            drawBorder: false
                        },
                        ticks: { 
                            color: '#6B7280',
                            precision: 0,
                            font: {
                                size: 11,
                                family: 'Inter, system-ui, sans-serif'
                            }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { 
                            color: '#6B7280',
                            font: {
                                size: 11,
                                family: 'Inter, system-ui, sans-serif'
                            }
                        }
                    }
                },
                elements: {
                    bar: {
                        borderRadius: 6,
                        borderSkipped: 'bottom',
                    }
                }
            }
        },
        doughnut: {
            type: 'doughnut',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#4B5563',
                            padding: 16,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: { 
                                size: 11,
                                family: 'Inter, system-ui, sans-serif'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#111827',
                        bodyColor: '#4B5563',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        padding: 4,
                        displayColors: true,
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: {
                    animateScale: true,
                    animateRotate: true
                },
                elements: {
                    arc: {
                        borderWidth: 2,
                        borderColor: '#fff'
                    }
                }
            }
        }
    };

    // Modern color schemes with better contrast and aesthetics
    const chartColors = {
        pink: {
            light: 'rgba(236, 72, 153, 0.15)',
            DEFAULT: 'rgba(236, 72, 153, 0.9)',
            dark: 'rgba(190, 24, 93, 0.9)',
            hover: 'rgba(236, 72, 153, 1)',
            gradient: ['#FF0080', '#FF8C66']
        },
        teal: {
            light: 'rgba(20, 184, 166, 0.15)',
            DEFAULT: 'rgba(20, 184, 166, 0.9)',
            dark: 'rgba(15, 118, 110, 0.9)',
            hover: 'rgba(20, 184, 166, 1)',
            gradient: ['#00F2FE', '#4FACFE']
        },
        blue: {
            light: 'rgba(59, 130, 246, 0.15)',
            DEFAULT: 'rgba(59, 130, 246, 0.9)',
            dark: 'rgba(29, 78, 216, 0.9)',
            hover: 'rgba(59, 130, 246, 1)',
            gradient: ['#1E3C72', '#2A5298']
        },
        purple: {
            light: 'rgba(168, 85, 247, 0.15)',
            DEFAULT: 'rgba(168, 85, 247, 0.9)',
            dark: 'rgba(126, 34, 206, 0.9)',
            hover: 'rgba(168, 85, 247, 1)',
            gradient: ['#4776E6', '#8E54E9']
        },
        yellow: {
            light: 'rgba(245, 158, 11, 0.15)',
            DEFAULT: 'rgba(245, 158, 11, 0.9)',
            dark: 'rgba(217, 119, 6, 0.9)',
            hover: 'rgba(245, 158, 11, 1)',
            gradient: ['#F7971E', '#FFD200']
        }
    };

    // Register plugins
    Chart.register(ChartDataLabels);

    // Create a line chart with enhanced interactivity and animations
    function createLineChart(canvasId, label, data) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        
        const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, chartColors.pink.light);
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0.1)');
        
        // Add subtle animation on data points
        const totalDuration = 2000;
        const delayBetweenPoints = totalDuration / data.data.length;
        const previousY = (ctx) => ctx.index === 0
            ? ctx.chart.scales.y.getPixelForValue(100)
            : ctx.chart.getDatasetMeta(ctx.datasetIndex).data[ctx.index - 1].getProps(['y'], true).y;
            
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: label,
                    data: data.data,
                    borderColor: chartColors.pink.DEFAULT,
                    backgroundColor: gradient,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: chartColors.pink.DEFAULT,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: chartColors.pink.dark,
                    pointHoverBorderWidth: 3,
                    pointRadius: 0.3,
                    pointHoverRadius: 1,
                    borderWidth: 0.8,
                    pointHitRadius: 15,
                    pointStyle: 'circle',
                    // Custom animation
                    animation: {
                        x: {
                            type: 'number',
                            easing: 'easeInOutQuart',
                            duration: delayBetweenPoints,
                            from: NaN, // the point is initially skipped
                            delay(ctx) {
                                if (ctx.type !== 'data' || ctx.xStarted) {
                                    return 0;
                                }
                                ctx.xStarted = true;
                                return ctx.index * delayBetweenPoints;
                            }
                        },
                        y: {
                            type: 'number',
                            easing: 'easeInOutQuart',
                            duration: delayBetweenPoints * 1.5,
                            from: previousY,
                            delay(ctx) {
                                if (ctx.type !== 'data' || ctx.yStarted) {
                                    return 0;
                                }
                                ctx.yStarted = true;
                                return ctx.index * delayBetweenPoints;
                            }
                        }
                    }
                }]
            },
            options: {
                ...chartConfig.line.options,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    ...chartConfig.line.options.plugins,
                    title: {
                        display: true,
                        text: label,
                        color: '#111827',
                        font: {
                            size: 7,
                            weight: '600',
                            family: 'Inter, system-ui, sans-serif'
                        },
                        padding: { bottom: 0 }
                    },
                    tooltip: {
                        ...chartConfig.line.options.plugins.tooltip,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.98)',
                        titleColor: '#111827',
                        bodyColor: '#4B5563',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        padding: 4,
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                return ` ${context.dataset.label}: ${context.parsed.y} days`;
                            },
                            labelColor: function(context) {
                                return {
                                    borderColor: chartColors.pink.DEFAULT,
                                    backgroundColor: chartColors.pink.DEFAULT,
                                    borderWidth: 2,
                                    borderRadius: 2
                                };
                            },
                            labelTextColor: function() {
                                return '#111827';
                            }
                        }
                    }
                },
                animations: {
                    radius: {
                        duration: 400,
                        easing: 'easeOutQuart',
                        from: 0,
                        to: 1,
                        loop: false
                    }
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    ...chartConfig.line.options.scales,
                    y: {
                        ...chartConfig.line.options.scales.y,
                        grid: {
                            ...chartConfig.line.options.scales.y.grid,
                            color: 'rgba(0, 0, 0, 0.03)',
                            drawBorder: false,
                            drawTicks: false
                        },
                        ticks: {
                            ...chartConfig.line.options.scales.y.ticks,
                            padding: 10
                        }
                    },
                    x: {
                        ...chartConfig.line.options.scales.x,
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            ...chartConfig.line.options.scales.x.ticks,
                            padding: 10
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4,
                        borderWidth: 3,
                        fill: true,
                        cubicInterpolationMode: 'monotone'
                    },
                    point: {
                        radius: 4,
                        hoverRadius: 8,
                        hoverBorderWidth: 3,
                        backgroundColor: 'white',
                        borderColor: chartColors.pink.DEFAULT,
                        borderWidth: 2,
                        hitRadius: 15,
                        hoverBorderColor: chartColors.pink.dark,
                        hoverBackgroundColor: 'white'
                    }
                },
                layout: {
                    padding: {
                        top: 1,
                        right: 1,
                        bottom: 1,
                        left: 1
                    }
                }
            }
        });
        
        return chart;
    }

    // Create a bar chart with enhanced interactivity and animations
    function createBarChart(canvasId, label, data) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        
        // Create gradient for each bar
        const createGradient = (ctx, area, colorIndex) => {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            const colors = Object.values(chartColors);
            const color = colors[colorIndex % colors.length];
            
            gradient.addColorStop(0, color.DEFAULT);
            gradient.addColorStop(1, color.dark);
            return gradient;
        };
        
        const backgroundColors = data.labels.map((_, i) => {
            const colors = Object.values(chartColors);
            return colors[i % colors.length].DEFAULT;
        });
        
        const hoverColors = data.labels.map((_, i) => {
            const colors = Object.values(chartColors);
            return colors[i % colors.length].hover;
        });
        
        // Animation configuration
        const totalDuration = 2000;
        const delayBetweenPoints = totalDuration / data.data.length;
        
        const chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: label,
                    data: data.data,
                    backgroundColor: (context) => {
                        const chart = context.chart;
                        const { ctx, chartArea } = chart;
                        if (!chartArea) return null;
                        return createGradient(ctx, chartArea, context.dataIndex);
                    },
                    borderColor: 'transparent',
                    borderWidth: 0,
                    borderRadius: {
                        topLeft: 6,
                        topRight: 6,
                        bottomLeft: 0,
                        bottomRight: 0
                    },
                    hoverBackgroundColor: hoverColors,
                    hoverBorderColor: 'transparent',
                    hoverBorderWidth: 0,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8,
                    // Animation
                    animation: {
                        y: {
                            type: 'number',
                            easing: 'easeOutQuart',
                            duration: (ctx) => {
                                const data = ctx.dataset.data;
                                const maxData = Math.max(...data);
                                const index = ctx.dataIndex;
                                return (data[index] / maxData) * totalDuration;
                            },
                            from: (ctx) => {
                                const chart = ctx.chart;
                                const { chartArea } = chart;
                                if (!chartArea) return 0;
                                return chartArea.bottom;
                            },
                            to: (ctx) => ctx.parsed.y
                        }
                    }
                }]
            },
            options: {
                ...chartConfig.bar.options,
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    ...chartConfig.bar.options.plugins,
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: label,
                        color: '#111827',
                        font: {
                            size: 7,
                            weight: '600',
                            family: 'Inter, system-ui, sans-serif'
                        },
                        padding: { bottom: 0 }
                    },
                    tooltip: {
                        ...chartConfig.bar.options.plugins.tooltip,
                        backgroundColor: 'rgba(255, 255, 255, 0.98)',
                        titleColor: '#111827',
                        bodyColor: '#4B5563',
                        borderColor: '#E5E7EB',
                        borderWidth: 1,
                        padding: 4,
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                        usePointStyle: true,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return ` ${value} ${label.toLowerCase().includes('pain') ? 'days' : 'occurrences'} (${percentage}%)`;
                            },
                            labelColor: function(context) {
                                const colors = Object.values(chartColors);
                                const color = colors[context.dataIndex % colors.length];
                                return {
                                    borderColor: color.DEFAULT,
                                    backgroundColor: color.DEFAULT,
                                    borderWidth: 2,
                                    borderRadius: 2
                                };
                            },
                            labelTextColor: function() {
                                return '#111827';
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: (context) => {
                            const colors = Object.values(chartColors);
                            return colors[context.dataIndex % colors.length].dark;
                        },
                        font: {
                            weight: 'bold',
                            size: 11
                        },
                        formatter: (value) => value > 0 ? value : '',
                        padding: 4,
                        borderRadius: 4,
                        backgroundColor: 'rgba(255, 255, 255, 0.8)'
                    }
                },
                scales: {
                    y: {
                        ...chartConfig.bar.options.scales.y,
                        grid: {
                            ...chartConfig.bar.options.scales.y.grid,
                            color: 'rgba(0, 0, 0, 0.03)',
                            drawBorder: false,
                            drawTicks: false
                        },
                        ticks: {
                            ...chartConfig.bar.options.scales.y.ticks,
                            padding: 10,
                            precision: 0
                        }
                    },
                    x: {
                        ...chartConfig.bar.options.scales.x,
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            ...chartConfig.bar.options.scales.x.ticks,
                            padding: 10
                        }
                    }
                },
                elements: {
                    bar: {
                        borderRadius: 6,
                        borderSkipped: 'bottom',
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const { ctx, chartArea } = chart;
                            if (!chartArea) return null;
                            return createGradient(ctx, chartArea, context.dataIndex);
                        },
                        hoverBackgroundColor: (context) => {
                            const colors = Object.values(chartColors);
                            return colors[context.dataIndex % colors.length].hover;
                        },
                        borderWidth: 0,
                        borderColor: 'transparent',
                        hoverBorderWidth: 0,
                        hoverBorderColor: 'transparent'
                    }
                },
                layout: {
                    padding: {
                        top: 1,
                        right: 1,
                        bottom: 1,
                        left: 1
                    }
                },
                animation: {
                    y: {
                        type: 'number',
                        easing: 'easeOutQuart',
                        duration: 1000,
                        from: (ctx) => {
                            const chart = ctx.chart;
                            const { chartArea } = chart;
                            if (!chartArea) return 0;
                            return chartArea.bottom;
                        },
                        delay: (ctx) => {
                            return ctx.dataIndex * 100;
                        }
                    }
                }
            }
        });
        
        return chart;
    }

    // Create charts with error handling
    try {
        const charts = {
            cycleLength: createLineChart('cycleLengthChart', 'Cycle Length (days)', chartData.cycleLength),
            periodLength: createLineChart('periodLengthChart', 'Period Length (days)', chartData.periodLength),
            symptoms: createBarChart('symptomsChart', 'Symptom Frequency', chartData.symptoms),
            moods: createDoughnutChart('moodChart', 'Mood Distribution', chartData.moods),
            flowIntensity: createDoughnutChart('flowIntensityChart', 'Flow Intensity', chartData.flowIntensity),
            painLevels: createBarChart('painLevelChart', 'Pain Level Frequency', chartData.painLevels)
        };
        
        // Store charts for later access
        window.menstrualCharts = charts;
        
        // Add animation class to containers after charts are rendered
        document.querySelectorAll('.chart-container').forEach(container => {
            container.style.opacity = '0';
            container.style.transition = 'opacity 0.5s ease-in-out';
            setTimeout(() => {
                container.style.opacity = '1';
            }, 100);
        });
        
    } catch (error) {
        console.error('Error initializing charts:', error);
        showError('Failed to load charts. Please refresh the page or try again later.');
    }

    // Add responsive behavior
    function handleResize() {
        if (window.innerWidth < 768) {
            // Adjust chart options for mobile
            chartConfig.doughnut.options.cutout = '60%';
            chartConfig.doughnut.options.plugins.legend.position = 'bottom';
        } else {
            // Reset to default for larger screens
            chartConfig.doughnut.options.cutout = '70%';
            chartConfig.doughnut.options.plugins.legend.position = 'right';
        }
        
        // Update all charts
        Chart.helpers.each(Chart.instances, function(chart) {
            chart.update('resize');
        });
    }

    // Initialize when the DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Set up responsive behavior
        window.addEventListener('resize', handleResize);
        handleResize(); // Initial check
        console.log('DOM fully loaded - initializing charts...');
        
        // Initialize progress bars
        $('.progress-bar').each(function() {
            $(this).css('width', $(this).data('width') + '%');
        });
        
        // If no chart data is available, show empty states
        if (!hasChartData()) {
            console.log('No chart data available, showing empty states');
            showInfo('No data available to display. Start tracking your cycles to see analytics.');
        }
    });
</script>
{% endblock %}
