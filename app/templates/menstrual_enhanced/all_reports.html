{% extends "base.html" %}

{% block title %}All Health Reports - Hercure{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Back button -->
    <a href="{{ url_for('menstrual_enhanced.health_reports') }}" 
       class="inline-flex items-center text-brand-pink hover:text-pink-700 mb-6">
        <i class="fas fa-arrow-left mr-2"></i> Back to Health Reports
    </a>
    
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">All Health Reports</h1>
            <p class="text-gray-600 mt-2">View and manage all your uploaded health reports</p>
        </div>
    </div>
    
    <!-- Reports Table -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Report Name
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Type
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Upload Date
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="relative px-6 py-3">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for report in reports %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                {{ report.filename }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-brand-teal-100 text-brand-teal-800">
                                {{ report.report_type|capitalize }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ report.upload_date.strftime('%b %d, %Y') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if report.analysis %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Analyzed
                            </span>
                            {% else %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                Pending
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            {% if report.analysis %}
                            <a href="{{ url_for('menstrual_enhanced_health_reports.view_analysis', report_id=report.id) }}" 
                               class="text-brand-pink hover:text-pink-700 mr-4">
                                View Analysis
                            </a>
                            {% else %}
                            <button onclick="analyzeReport('{{ report.id }}', this)" 
                                    class="text-brand-teal-600 hover:text-brand-teal-800 mr-4">
                                Analyze
                            </button>
                            {% endif %}
                            <a href="{{ url_for('menstrual_enhanced_health_reports.download_report', report_id=report.id) }}" 
                               class="text-gray-600 hover:text-gray-900">
                                Download
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-file-medical text-4xl text-gray-300 mb-3"></i>
                            <p class="text-lg">No health reports found</p>
                            <p class="text-sm mt-2">Upload your first health report to get started</p>
                            <a href="{{ url_for('menstrual_enhanced.health_reports') }}" 
                               class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-brand-pink hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-pink">
                                <i class="fas fa-upload mr-2"></i> Upload Report
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
function analyzeReport(reportId, button) {
    const originalText = button.innerHTML;
    
    // Show loading state without disabling the button
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Analyzing...';
    
    // Call analyze endpoint
    fetch(`/menstrual-enhanced/health-reports/${reportId}/analyze`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(async response => {
        const data = await response.json().catch(() => ({}));
        
        if (!response.ok) {
            throw new Error(data.message || `Server returned ${response.status} status`);
        }
        
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
        } else if (data.success) {
            // Reload the page to show the updated analysis
            window.location.reload();
        } else {
            throw new Error(data.message || 'Failed to analyze report');
        }
    })
    .catch(error => {
        console.error('Analysis error:', error);
        // Show a more user-friendly error message
        const errorMessage = error.message || 'An error occurred while analyzing the report';
        
        // Check if we have a toast or notification system available
        if (window.showError) {
            window.showError(errorMessage);
        } else if (window.alert) {
            alert(errorMessage);
        }
        
        // Reset button state
        button.innerHTML = originalText;
    });
}
</script>
{% endblock %}
