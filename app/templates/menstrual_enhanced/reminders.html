{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Reminder Management</h1>
                    <p class="mt-2 text-lg text-gray-600">Set up personalized reminders for your menstrual health</p>
                </div>
                <button onclick="openCreateReminderModal()" 
                        class="bg-brand-pink-600 hover:bg-brand-pink-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Create Reminder
                </button>
            </div>
        </div>

        <!-- Upcoming Reminders -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <i class="fas fa-calendar-day text-brand-pink-600 mr-2"></i>
                    Upcoming Reminders
                </h3>
                <p class="text-sm text-gray-500 mt-1">Your next reminders</p>
            </div>
            <div class="p-6">
                <div id="upcoming-reminders" class="space-y-4">
                    <!-- Upcoming reminders will be injected here -->
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                        <p class="mt-2 text-gray-600 text-sm">Loading upcoming reminders...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- All Active Reminders -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i class="fas fa-bell text-brand-pink-600 mr-2"></i>
                        All Reminders
                    </h3>
                    <p class="text-sm text-gray-500 mt-1">Manage all your scheduled reminders</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="toggle-completed" 
                            class="text-sm text-brand-pink-600 hover:text-brand-pink-700 font-medium">
                        Show Completed
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="reminders-list" class="space-y-4">
                    <!-- Reminders will be dynamically injected here -->
                </div>
                <div id="reminders-loading" class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-gray-400 text-4xl"></i>
                    <p class="mt-2 text-gray-600">Loading reminders...</p>
                </div>
                <div id="reminders-empty" class="text-center py-12 hidden">
                    <i class="fas fa-bell-slash text-gray-400 text-4xl mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-900">No Active Reminders</h4>
                    <p class="text-gray-600 mt-1">You're all caught up! Create a new reminder to get started.</p>
                    <button onclick="openCreateReminderModal()" 
                            class="mt-4 bg-brand-pink-600 hover:bg-brand-pink-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create Your First Reminder
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification Settings (Static for now) -->
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="h5 mb-0">Notification Preferences</h3>
            </div>
            <div class="card-body">
                <p class="text-muted mb-0">Notification settings will be configurable here in a future update.</p>
            </div>
        </div>
    </div>
</div>

<!-- Create Reminder Modal -->
<div id="createReminderModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create a New Reminder</h5>
                <button type="button" class="btn-close" onclick="closeCreateReminderModal()" aria-label="Close"></button>
            </div>
            <form id="createReminderForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="reminderTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="reminderTitle" name="title" required 
                               placeholder="e.g., Take evening medication">
                    </div>
                    <div class="mb-3">
                        <label for="reminderMessage" class="form-label">Message (Optional)</label>
                        <textarea class="form-control" id="reminderMessage" name="message" 
                                 rows="3" placeholder="Reminder message"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="reminderDateTime" class="form-label">Date & Time</label>
                        <input type="datetime-local" class="form-control" id="reminderDateTime" 
                               name="scheduled_date" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" 
                            onclick="closeCreateReminderModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Reminder</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Main application object
const RemindersApp = (function() {
    'use strict';
    
    // Private variables
    const API_BASE_URL = '{{ url_for("menstrual_enhanced.get_reminders_api") }}'.replace('/api/reminders', '');
    let showCompleted = false;
    let createReminderModal = null;
    
    // CSRF token for API requests
    const csrfToken = document.head.querySelector('meta[name="csrf-token"]')?.content || '';
    
    // Default headers for fetch requests
    const defaultHeaders = {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'  // For CSRF protection
    };
    
    // Check for due reminders every 30 seconds
    const REMINDER_CHECK_INTERVAL = 30 * 1000; // 30 seconds
    
    // DOM Elements
    const elements = {
        createReminderModalEl: document.getElementById('createReminderModal'),
        createReminderForm: document.getElementById('createReminderForm'),
        remindersList: document.getElementById('reminders-list'),
        upcomingReminders: document.getElementById('upcoming-reminders'),
        remindersLoading: document.getElementById('reminders-loading'),
        remindersEmpty: document.getElementById('reminders-empty'),
        toggleCompletedBtn: document.getElementById('toggle-completed')
    };
    
    // Public API
    return {
        init: init,
        openCreateReminderModal: function() {
            if (createReminderModal) {
                createReminderModal.show();
            }
        },
        closeCreateReminderModal: function() {
            if (elements.createReminderForm) {
                elements.createReminderForm.reset();
            }
            if (createReminderModal) {
                createReminderModal.hide();
            }
        },
        markReminderAsDone: markReminderAsDone,
        deleteReminder: deleteReminder
    };
    
    // Initialize the application
    function init() {
        // Initialize modal if Bootstrap is available
        if (window.bootstrap && elements.createReminderModalEl) {
            createReminderModal = new bootstrap.Modal(elements.createReminderModalEl);
        }
        
        // Add event listeners
        if (elements.toggleCompletedBtn) {
            elements.toggleCompletedBtn.addEventListener('click', toggleCompletedReminders);
        }
        
        if (elements.createReminderForm) {
            elements.createReminderForm.addEventListener('submit', handleCreateReminder);
        }
        
        // Set default reminder time to next hour
        const now = new Date();
        now.setHours(now.getHours() + 1, 0, 0, 0); // Next hour
        const defaultTime = now.toISOString().slice(0, 16);
        const timeInput = document.getElementById('reminderDateTime');
        if (timeInput) {
            timeInput.min = new Date().toISOString().slice(0, 16);
            timeInput.value = defaultTime;
        }
        
        // Initial data load
        fetchAndRenderReminders();
        fetchAndRenderUpcomingReminders();
        
        // Add styles
        addCustomStyles();
        
        return this; // Return the RemindersApp instance for method chaining
    }
    
    // Toggle completed reminders
    function toggleCompletedReminders() {
        showCompleted = !showCompleted;
        if (elements.toggleCompletedBtn) {
            elements.toggleCompletedBtn.textContent = showCompleted ? 'Hide Completed' : 'Show Completed';
            elements.toggleCompletedBtn.classList.toggle('active', showCompleted);
        }
        fetchAndRenderReminders();
    }
    
    // Handle create reminder form submission
    async function handleCreateReminder(event) {
        event.preventDefault();
        console.log('Form submission started');
        
        const form = event.target;
        const formData = new FormData(form);
        const title = formData.get('title');
        const message = formData.get('message');
        const scheduledDate = formData.get('scheduled_date');
        
        console.log('Form data:', { title, message, scheduledDate });
        
        if (!title || !scheduledDate) {
            const errorMsg = 'Title and date/time are required';
            console.error('Validation error:', errorMsg);
            showError(errorMsg);
            return;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        
        try {
            // Create reminder data
            const reminderData = {
                title: title,
                message: message || '',
                scheduled_date: new Date(scheduledDate).toISOString(),
                notification_methods: ['in_app']
            };
            
            console.log('Creating reminder with data:', reminderData);
            
            // Send request to create reminder
            console.log('Sending request to /api/reminders with data:', reminderData);
            
            const response = await fetch('/api/reminders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                credentials: 'same-origin',
                body: JSON.stringify(reminderData)
            });
            
            console.log('Response status:', response.status, response.statusText);
            
            let result;
            try {
                result = await response.json();
                console.log('Response data:', result);
            } catch (e) {
                console.error('Error parsing JSON response:', e);
                throw new Error('Invalid response from server');
            }
            
            if (!response.ok) {
                throw new Error(result.message || result.error || 'Failed to create reminder');
            }
            
            // Close modal and refresh reminders
            closeCreateReminderModal();
            showSuccess('Reminder created successfully!');
            await fetchAndRenderReminders();
            await fetchAndRenderUpcomingReminders();
            
        } catch (error) {
            console.error('Error creating reminder:', error);
            const errorMessage = error.message || 'Failed to create reminder. Please try again.';
            console.error('Error details:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
            showError(errorMessage);
        } finally {
            // Reset button state
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Create Reminder';
            }
        }
    }

document.addEventListener('DOMContentLoaded', () => {
    const reminderList = document.getElementById('reminders-list');
    const loadingIndicator = document.getElementById('reminders-loading');
    const emptyState = document.getElementById('reminders-empty');
    const createReminderForm = document.getElementById('createReminderForm');

    // --- Fetch and Render Upcoming Reminders ---
    const fetchAndRenderUpcomingReminders = async () => {
        const upcomingContainer = document.getElementById('upcoming-reminders');
        
        try {
            const response = await fetch(UPCOMING_REMINDERS_URL);
            if (!response.ok) throw new Error('Failed to fetch upcoming reminders.');
            
            const reminders = await response.json();
            
            if (reminders && reminders.length > 0) {
                upcomingContainer.innerHTML = '';
                reminders.forEach(reminder => {
                    const reminderEl = createUpcomingReminderElement(reminder);
                    upcomingContainer.appendChild(reminderEl);
                });
                
                // Add a link to view all reminders if there are more than 2
                if (reminders.length >= 2) {
                    const viewAllLink = document.createElement('a');
                    viewAllLink.href = '#';
                    viewAllLink.className = 'block mt-4 text-center text-sm text-brand-pink-600 hover:underline';
                    viewAllLink.textContent = 'View all reminders';
                    viewAllLink.onclick = (e) => {
                        e.preventDefault();
                        document.getElementById('reminders-list').scrollIntoView({ behavior: 'smooth' });
                    };
                    upcomingContainer.appendChild(viewAllLink);
                }
            } else {
                upcomingContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="far fa-calendar-check text-2xl mb-2"></i>
                        <p>No upcoming reminders</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            upcomingContainer.innerHTML = `
                <div class="text-center py-4 text-red-500">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Failed to load upcoming reminders
                </div>
            `;
        }
    };

    // --- Create Upcoming Reminder Element ---
    const createUpcomingReminderElement = (reminder) => {
        const reminderEl = document.createElement('div');
        reminderEl.className = 'card mb-3 reminder-card upcoming';
        
        const scheduledDate = new Date(reminder.scheduled_date);
        const now = new Date();
        const timeDiff = scheduledDate - now;
        const hoursUntil = Math.floor(timeDiff / (1000 * 60 * 60));
        
        let timeText = '';
        if (hoursUntil < 1) {
            const minutes = Math.floor(timeDiff / (1000 * 60));
        }
    }
    
    // Modal functions
    function openCreateReminderModal() {
        // Set default date/time to now + 1 hour
        const now = new Date();
        now.setHours(now.getHours() + 1);
        
        // Format for datetime-local input (YYYY-MM-DDThh:mm)
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`;
        const dateInput = document.querySelector('#createReminderForm [name="scheduled_date"]');
        if (dateInput) {
            dateInput.value = formattedDate;
        }
        
        // Show modal
        if (createReminderModal) {
            createReminderModal.classList.remove('hidden');
        }
    }
    
    function closeCreateReminderModal() {
        if (createReminderForm) {
            createReminderForm.reset();
        }
        if (createReminderModal) {
            createReminderModal.classList.add('hidden');
        }
    }
    
    // Helper function to show error messages
    function showError(message) {
        // Create or update error message element
        let errorEl = document.getElementById('reminder-error');
        if (!errorEl) {
            errorEl = document.createElement('div');
            errorEl.id = 'reminder-error';
            errorEl.className = 'bg-red-50 border-l-4 border-red-500 p-4 mb-4';
            errorEl.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">${message}</p>
                    </div>
                </div>`;
            
            // Insert error message at the top of the reminders section
            const container = document.querySelector('.reminders-container');
            if (container) {
                container.insertBefore(errorEl, container.firstChild);
            }
        } else {
            // Update existing error message
            errorEl.querySelector('p').textContent = message;
            errorEl.classList.remove('hidden');
        }
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (errorEl) errorEl.classList.add('hidden');
        }, 5000);
    }
    
    // Helper function to show success messages
    function showSuccess(message) {
        // Create or update success message element
        let successEl = document.getElementById('reminder-success');
        if (!successEl) {
            successEl = document.createElement('div');
            successEl.id = 'reminder-success';
            successEl.className = 'bg-green-50 border-l-4 border-green-500 p-4 mb-4';
            successEl.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-green-700">${message}</p>
                    </div>
                </div>`;
            
            // Insert success message at the top of the reminders section
            const container = document.querySelector('.reminders-container');
            if (container) {
                container.insertBefore(successEl, container.firstChild);
            }
        } else {
            // Update existing success message
            successEl.querySelector('p').textContent = message;
            successEl.classList.remove('hidden');
        }
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (successEl) successEl.classList.add('hidden');
        }, 5000);
    }
    
    // API Functions
    async function fetchAndRenderReminders() {
        // Get references to DOM elements
        const remindersList = elements.remindersList;
        const remindersLoading = elements.remindersLoading;
        const remindersEmpty = elements.remindersEmpty;
        
        // Show loading state
        if (remindersLoading) {
            remindersLoading.classList.remove('hidden');
        }
        if (remindersList) {
            remindersList.classList.add('opacity-50');
            remindersList.innerHTML = ''; // Clear existing content
        }
        if (remindersEmpty) {
            remindersEmpty.classList.add('hidden');
        }
        
        try {
            // Build API URL with query parameters
            const url = new URL(REMINDERS_API_URL);
            if (showCompleted) {
                url.searchParams.append('all', 'true');
            }
            
            // Fetch reminders from API
            const response = await fetch(url, {
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || 'Failed to fetch reminders');
            }
            
            const data = await response.json();
            
            // Render reminders
            if (Array.isArray(data)) {
                renderReminders(data);
                
                // Show empty state if no reminders
                if (data.length === 0 && remindersEmpty) {
                    remindersEmpty.classList.remove('hidden');
                }
                
                // Also update upcoming reminders
                const upcoming = data.filter(r => new Date(r.scheduled_date) > new Date() && !r.is_completed);
                renderUpcomingReminders(upcoming.slice(0, 2)); // Show next 2 upcoming
            } else {
                renderReminders(data.reminders || []);
                renderUpcomingReminders(data.upcoming_reminders || []);
                
                // Show empty state if no reminders
                if ((!data.reminders || data.reminders.length === 0) && remindersEmpty) {
                    remindersEmpty.classList.remove('hidden');
                }
            }
            
        } catch (error) {
            console.error('Error fetching reminders:', error);
            showError('Failed to load reminders. ' + (error.message || 'Please try again later.'));
        } finally {
            // Hide loading state
            if (remindersLoading) {
                remindersLoading.classList.add('hidden');
            }
            if (remindersList) {
                remindersList.classList.remove('opacity-50');
            }
        }
    }
    
    function formatDateTime(dateTimeString) {
        if (!dateTimeString) return '';
        
        const date = new Date(dateTimeString);
        if (isNaN(date.getTime())) return '';
        
        // Format as "Today at 2:30 PM" or "Tomorrow at 10:00 AM" or "Mon, Jun 5 at 2:30 PM"
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const timeStr = date.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
        });
        
        if (date.toDateString() === today.toDateString()) {
            return `Today at ${timeStr}`;
        } else if (date.toDateString() === tomorrow.toDateString()) {
            return `Tomorrow at ${timeStr}`;
        } else {
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric' 
            }) + ` at ${timeStr}`;
        }
    }
    
    function renderReminders(reminders) {
        const remindersList = elements.remindersList;
        if (!remindersList) return;
        
        // Clear existing content but keep loading/empty states
        const existingNodes = Array.from(remindersList.children);
        for (const node of existingNodes) {
            if (!node.id || (!node.id.includes('loading') && !node.id.includes('empty'))) {
                node.remove();
            }
        }
        
        if (!reminders || reminders.length === 0) {
            return;
        }
        
        // Sort reminders by scheduled date (soonest first)
        const sortedReminders = [...reminders].sort((a, b) => {
            return new Date(a.scheduled_date) - new Date(b.scheduled_date);
        });
        
        // Group reminders by date
        const remindersByDate = {};
        sortedReminders.forEach(reminder => {
            const date = new Date(reminder.scheduled_date);
            const dateKey = date.toDateString();
            
            if (!remindersByDate[dateKey]) {
                remindersByDate[dateKey] = [];
            }
            remindersByDate[dateKey].push(reminder);
        });
        
        // Create and append reminder elements
        Object.entries(remindersByDate).forEach(([dateKey, dateReminders]) => {
            // Add date header
            const dateHeader = document.createElement('div');
            dateHeader.className = 'text-sm font-medium text-gray-500 mb-2 mt-4 first:mt-0';
            dateHeader.textContent = new Date(dateKey).toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            remindersList.appendChild(dateHeader);
            
            // Add reminders for this date
            dateReminders.forEach(reminder => {
                const reminderEl = renderReminder(reminder);
                if (reminderEl) {
                    remindersList.appendChild(reminderEl);
                }
            });
        });
    }
    
    function renderUpcomingReminders(reminders) {
        const upcomingRemindersEl = elements.upcomingReminders;
        if (!upcomingRemindersEl) return;
        
        // Clear existing content but keep loading state
        const existingNodes = Array.from(upcomingRemindersEl.children);
        for (const node of existingNodes) {
            if (!node.id || !node.id.includes('loading')) {
                node.remove();
            }
        }
        
        if (!reminders || reminders.length === 0) {
            upcomingRemindersEl.innerHTML = `
                <div class="text-center py-6">
                    <div class="text-gray-400 mb-2">
                        <i class="far fa-bell-slash text-4xl"></i>
                    </div>
                    <p class="text-gray-500 text-sm">No upcoming reminders</p>
                    <button onclick="openCreateReminderModal()" 
                            class="mt-3 text-sm text-brand-pink-600 hover:text-brand-pink-700 font-medium">
                        <i class="fas fa-plus mr-1"></i> Create a reminder
                    </button>
                </div>`;
            return;
        }
        
        // Sort by scheduled date (soonest first)
        const sortedReminders = [...reminders].sort((a, b) => 
            new Date(a.scheduled_date) - new Date(b.scheduled_date)
        );
        
        // Create a container for the upcoming reminders
        const container = document.createElement('div');
        container.className = 'space-y-3';
        
        // Add each upcoming reminder
        sortedReminders.slice(0, 3).forEach((reminder, index) => {
            const reminderEl = document.createElement('div');
            reminderEl.className = `bg-white p-4 rounded-lg border border-gray-100 shadow-sm hover:shadow transition-shadow ${index > 0 ? 'mt-3' : ''}`;
            
            const timeStr = formatDateTime(reminder.scheduled_date);
            const isToday = new Date(reminder.scheduled_date).toDateString() === new Date().toDateString();
            
            reminderEl.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-medium text-gray-900 truncate">${reminder.title || 'Reminder'}</h4>
                        <div class="mt-1 flex items-center text-sm text-gray-500">
                            <i class="far fa-clock mr-1.5"></i>
                            <span>${timeStr}</span>
                            ${isToday ? '<span class="ml-2 px-1.5 py-0.5 text-xs font-medium bg-brand-pink-100 text-brand-pink-800 rounded-full">Today</span>' : ''}
                        </div>
                        ${reminder.message ? `<p class="mt-1 text-sm text-gray-600 line-clamp-2">${reminder.message}</p>` : ''}
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button onclick="markReminderAsDone('${reminder._id || reminder.id}')" 
                                class="text-green-600 hover:text-green-800 p-1 rounded-full hover:bg-green-50"
                                title="Mark as done">
                            <i class="far fa-check-circle"></i>
                        </button>
                    </div>
                </div>`;
            
            container.appendChild(reminderEl);
        });
        
        // Add a link to view all reminders if there are more
        if (sortedReminders.length > 3) {
            const viewAllLink = document.createElement('div');
            viewAllLink.className = 'text-center mt-3';
            viewAllLink.innerHTML = `
                <button onclick="document.querySelector('#reminders-list').scrollIntoView({ behavior: 'smooth' })" 
                        class="text-sm text-brand-pink-600 hover:text-brand-pink-700 font-medium">
                    View all ${sortedReminders.length} reminders
                </button>`;
            container.appendChild(viewAllLink);
        }
        
        upcomingRemindersEl.appendChild(container);
    }
    
    function renderReminder(reminder) {
        if (!reminder || !reminder._id) return null;
        
        const reminderEl = document.createElement('div');
        const baseClasses = 'p-4 rounded-lg border';
        const statusClasses = reminder.is_completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200 hover:shadow-md';
        reminderEl.className = `${baseClasses} ${statusClasses} transition-all`;
        
        const scheduledDate = new Date(reminder.scheduled_date);
        const now = new Date();
        const isPastDue = scheduledDate < now && !reminder.is_completed;
        
        const timeString = scheduledDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateString = scheduledDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
        
        let statusBadge = '';
        if (reminder.is_completed) {
            statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">' +
                '<i class="fas fa-check-circle mr-1"></i> Completed' +
                '</span>';
        } else if (isPastDue) {
            statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">' +
                '<i class="fas fa-clock mr-1"></i> Overdue' +
                '</span>';
        } else {
            const timeDiff = scheduledDate - now;
            const hoursUntil = Math.floor(timeDiff / (1000 * 60 * 60));
            
            if (hoursUntil < 24) {
                statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">' +
                    '<i class="fas fa-clock mr-1"></i> Today at ' + timeString +
                    '</span>';
            } else {
                statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">' +
                    '<i class="far fa-calendar-alt mr-1"></i> ' + dateString +
                    '</span>';
            }
        }
        
        const reminderId = reminder._id.$oid || reminder._id;
        const actions = !reminder.is_completed ? 
            '<button onclick="markReminderAsDone(\'' + reminderId + '\')" ' +
            'class="text-green-600 hover:text-green-800 p-2 rounded-full hover:bg-green-50" ' +
            'title="Mark as done">' +
            '<i class="fas fa-check"></i>' +
            '</button>' : '';
            
        const deleteBtn = '<button onclick="deleteReminder(\'' + reminderId + '\')" ' +
            'class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 ml-1" ' +
            'title="Delete reminder">' +
            '<i class="fas fa-trash"></i>' +
            '</button>';
        
        const completedClass = reminder.is_completed ? 'text-gray-400' : '';
        const completedStyle = reminder.is_completed ? 'text-decoration: line-through;' : '';
        
        reminderEl.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex items-start space-x-3">
                    <div class="mt-0.5">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center ${reminder.is_completed ? 'bg-green-100 text-green-600' : 'bg-brand-pink-100 text-brand-pink-600'}">
                            <i class="fas ${reminder.icon || 'fa-bell'} text-sm"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center flex-wrap gap-2">
                            <h4 class="font-medium text-gray-900 ${completedClass}" style="${completedStyle}">
                                ${reminder.title || 'Untitled Reminder'}
                            </h4>
                            ${statusBadge}
                        </div>
                        ${reminder.message ? `<p class="text-sm text-gray-600 mt-1">${reminder.message}</p>` : ''}
                        <div class="mt-1 text-xs text-gray-500">
                            <i class="far fa-clock mr-1"></i>
                            ${dateString} at ${timeString}
                        </div>
                    </div>
                </div>
                <div class="flex items-center">
                    ${actions}
                    ${deleteBtn}
                </div>
            </div>
        `;
        
        return reminderEl;
    }
    
    function renderUpcomingReminder(reminder) {
        if (!reminder) return null;
        
        const reminderEl = document.createElement('div');
        reminderEl.className = 'p-4 bg-blue-50 rounded-lg border border-blue-100';
        
        const scheduledDate = new Date(reminder.scheduled_date);
        const timeString = scheduledDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const dateString = scheduledDate.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
        
        reminderEl.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="mt-0.5">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center">
                        <i class="fas ${reminder.icon || 'fa-bell'} text-sm"></i>
                    </div>
                </div>
                <div class="flex-1">
                    <h4 class="font-medium text-gray-900">${reminder.title || 'Untitled Reminder'}</h4>
                    <div class="mt-1 text-sm text-gray-600">
                        <i class="far fa-clock mr-1"></i>
                        ${dateString} at ${timeString}
                    </div>
                    ${reminder.message ? `<p class="mt-1 text-sm text-gray-600">${reminder.message}</p>` : ''}
                </div>
            </div>
        `;
        
        return reminderEl;
    }
    
    async function createReminder() {
        if (!createReminderForm) return;
        
        const formData = new FormData(createReminderForm);
        const data = Object.fromEntries(formData.entries());
        
        // Basic validation
        if (!data.title || !data.scheduled_date) {
            showError('Please fill in all required fields');
            return;
        }
        
        try {
            const response = await fetch('/api/reminders', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'  // For CSRF protection
                },
                body: JSON.stringify(data)
            });

            const responseData = await response.json().catch(() => ({}));
            
            if (!response.ok) {
                throw new Error(responseData.message || 'Failed to create reminder. Please try again.');
            }

            // Refresh both lists
            await fetchAndRenderReminders();
            await fetchAndRenderUpcomingReminders();
            
            // Show success message
            const successMessage = document.createElement('div');
            successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center z-50';
            successMessage.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <span>Reminder created successfully!</span>
            `;
            document.body.appendChild(successMessage);
            
            // Auto-remove success message
            setTimeout(() => {
                successMessage.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => successMessage.remove(), 500);
            }, 3000);
            
            // Reset and close the form
            createReminderForm.reset();
            closeCreateReminderModal();
            
        } catch (error) {
            console.error('Error creating reminder:', error);
            
            // Show error message
            const errorMessage = document.createElement('div');
            errorMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center';
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>${error.message || 'Could not create reminder. Please try again.'}</span>
            `;
            document.body.appendChild(errorMessage);
            
            // Auto-remove error message
            setTimeout(() => {
                errorMessage.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => errorMessage.remove(), 500);
            }, 5000);
            
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
        }
    });

    // --- Delete Reminder ---
    window.deleteReminder = async (reminderId) => {
        if (!confirm('Are you sure you want to delete this reminder? This action cannot be undone.')) return;

        try {
            const response = await fetch(`${REMINDERS_API_URL}/${reminderId}`, { 
                method: 'DELETE' 
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete reminder.');
            }

            // Remove the reminder from the UI
            const reminderElement = document.getElementById(`reminder-${reminderId}`);
            if (reminderElement) {
                reminderElement.remove();
            }
            
            // Refresh the upcoming reminders
            fetchAndRenderUpcomingReminders();
            
            // Show empty state if no reminders left
            if (reminderList.children.length === 0) {
                emptyState.classList.remove('hidden');
            }
            
            // Show success message
            const successMessage = document.createElement('div');
            successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center';
            successMessage.innerHTML = `
                <i class="fas fa-check-circle mr-2"></i>
                <span>Reminder deleted successfully</span>
            `;
            document.body.appendChild(successMessage);
            
            // Auto-remove success message
            setTimeout(() => {
                successMessage.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => successMessage.remove(), 500);
            }, 3000);
        } catch (error) {
            console.error('Error:', error);
            alert('Could not delete reminder. Please try again.');
        }
    };

    // Add styles for the toggle button and reminders
    function addCustomStyles() {
        const style = document.createElement('style');
        style.id = 'reminders-styles';
        style.textContent = `
            #toggle-completed.active {
                font-weight: 600;
                background-color: #f3f4f6;
                border-color: #9ca3af;
            }
            .reminder-card {
                transition: all 0.2s ease;
            }
            .reminder-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .reminder-card.completed {
                opacity: 0.7;
            }
            .reminder-card.completed .card-title,
            .reminder-card.completed .card-text {
                text-decoration: line-through;
            }
            .reminder-actions {
                opacity: 0;
                transition: opacity 0.2s ease;
            }
            .reminder-card:hover .reminder-actions {
                opacity: 1;
            }`;
        
        // Only add styles if not already added
        if (!document.getElementById('reminders-styles')) {
            document.head.appendChild(style);
        }
    }
    
    // Initialize the application when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the app
        const app = RemindersApp.init();
        
        // Make app functions globally available for inline handlers
        window.openCreateReminderModal = app.openCreateReminderModal;
        window.closeCreateReminderModal = app.closeCreateReminderModal;
        window.markReminderAsDone = app.markReminderAsDone;
        window.deleteReminder = app.deleteReminder;
        
        // Request notification permission on page load
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                } else {
                    console.log('Notification permission denied.');
                }
            });
        }
        
        // Initial data load
        fetchAndRenderReminders();
        fetchAndRenderUpcomingReminders();
        
        // Check for due reminders immediately and then every 30 seconds
        checkForDueReminders();
        setInterval(checkForDueReminders, REMINDER_CHECK_INTERVAL);
        
        // Refresh the upcoming reminders every 5 minutes
        setInterval(fetchAndRenderUpcomingReminders, 5 * 60 * 1000);
    });
    
    // Show a browser notification
    function showBrowserNotification(title, options = {}) {
        // Check if the browser supports notifications
        if (!('Notification' in window)) {
            console.warn('This browser does not support desktop notifications');
            return false;
        }
        
        // Check if notification permissions are already granted
        if (Notification.permission === 'granted') {
            // If it's okay, create a notification
            new Notification(title, options);
            return true;
        } 
        // Otherwise, ask the user for permission
        else if (Notification.permission !== 'denied') {
            Notification.requestPermission().then(function(permission) {
                // If the user accepts, create a notification
                if (permission === 'granted') {
                    new Notification(title, options);
                    return true;
                }
            });
        }
        
        return false;
    }
    
    // Check for due reminders
    async function checkForDueReminders() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/reminders/check`, {
                method: 'GET',
                headers: defaultHeaders,
                credentials: 'same-origin'  // Include cookies for authentication
            });
            
            if (!response.ok) {
                throw new Error('Failed to check for due reminders');
            }
            
            const data = await response.json();
            
            // Show notifications for due reminders
            if (data.status === 'success' && data.due_reminders && data.due_reminders.length > 0) {
                data.due_reminders.forEach(reminder => {
                    // Show browser notification
                    showBrowserNotification(reminder.title, {
                        body: reminder.message || 'Reminder triggered',
                        icon: '/static/images/logo.png',
                        tag: `reminder-${reminder._id}`
                    });
                    
                    // Show in-app notification
                    showSuccess(`Reminder: ${reminder.title}`, 10000); // Show for 10 seconds
                });
                
                // Refresh the reminders list
                fetchAndRenderReminders();
                fetchAndRenderUpcomingReminders();
            }
            
            return data.due_reminders || [];
            
        } catch (error) {
            console.error('Error checking for due reminders:', error);
            return [];
        }
    }
    
    // Initialize the application
    function init() {
        // Initialize UI components
        initElements();
        setupEventListeners();
        
        // Request notification permission on page load
        if ('Notification' in window) {
            Notification.requestPermission().then();
        }
        
        // Load initial data
        fetchAndRenderReminders();
        fetchAndRenderUpcomingReminders();
        
        // Check for due reminders immediately and then every 30 seconds
        checkForDueReminders();
        setInterval(checkForDueReminders, REMINDER_CHECK_INTERVAL);
        
        // Refresh the upcoming reminders every 5 minutes
        setInterval(fetchAndRenderUpcomingReminders, 5 * 60 * 1000);
    });
    
    // Return the public API
    return {
        init: init,
        openCreateReminderModal: function() {
            if (createReminderModal) {
                createReminderModal.show();
            }
        },
        closeCreateReminderModal: function() {
            if (elements.createReminderForm) {
                elements.createReminderForm.reset();
            }
            if (createReminderModal) {
                createReminderModal.hide();
            }
        },
        markReminderAsDone: markReminderAsDone,
        deleteReminder: deleteReminder
    };
})();
</script>
{% endblock %}
